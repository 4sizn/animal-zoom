<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat UI - Standalone Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }

    .demo-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 20px;
      gap: 20px;
    }

    .demo-header {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      margin: 0 0 10px 0;
      font-size: 28px;
    }

    .info {
      color: #666;
      font-size: 14px;
    }

    .chat-demo-wrapper {
      flex: 1;
      display: flex;
      gap: 20px;
      min-height: 0;
    }

    .chat-panel {
      flex: 1;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .controls-panel {
      width: 300px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }

    .controls-panel h3 {
      margin: 0 0 16px 0;
      color: #333;
      font-size: 18px;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .control-group label {
      display: block;
      margin-bottom: 8px;
      color: #666;
      font-size: 14px;
      font-weight: 600;
    }

    .control-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .control-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .control-group button {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .control-group button:hover {
      transform: translateY(-1px);
    }

    .status {
      padding: 10px;
      background: #e8f5e9;
      color: #2e7d32;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }

    #root {
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="demo-container">
    <div class="demo-header">
      <h1>ğŸ’¬ Chat UI - Standalone Demo</h1>
      <p class="info">
        React ê¸°ë°˜ ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ ë…ë¦½ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ í˜ì´ì§€
        <br>
        <strong>í¬íŠ¸:</strong> 5174 | <strong>íŒ¨í‚¤ì§€:</strong> @animal-zoom/chat-ui
      </p>
    </div>

    <div class="chat-demo-wrapper">
      <div class="chat-panel">
        <div id="root"></div>
      </div>

      <div class="controls-panel">
        <h3>âš™ï¸ ì»¨íŠ¸ë¡¤</h3>

        <div class="status" id="status">
          ì¤€ë¹„ë¨
        </div>

        <div class="control-group">
          <label>ì‚¬ìš©ì ì´ë¦„</label>
          <input
            type="text"
            id="userName"
            placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
            value="í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì"
          />
        </div>

        <div class="control-group">
          <label>ë°© ID</label>
          <input
            type="text"
            id="roomId"
            placeholder="room-123"
            value="demo-room"
          />
        </div>

        <div class="control-group">
          <button id="connectWS">WebSocket ì—°ê²°</button>
        </div>

        <div class="control-group">
          <button id="joinRoom">ë°© ìˆ˜ë™ ì°¸ê°€ (ì„ íƒì‚¬í•­)</button>
        </div>

        <div class="control-group">
          <button id="addTestMessage">í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì¶”ê°€ (ë¡œì»¬)</button>
        </div>

        <div class="control-group">
          <button id="clearMessages">ë©”ì‹œì§€ ì§€ìš°ê¸°</button>
        </div>

        <div class="control-group">
          <button id="toggleChat">ì±„íŒ… í† ê¸€</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import React from 'react';
    import ReactDOM from 'react-dom/client';
    import { ChatContainer, useChatStore } from './src/index.tsx';

    // Initialize React app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(ChatContainer));

    // Status helper
    const setStatus = (message, isError = false) => {
      const status = document.getElementById('status');
      status.textContent = message;
      status.style.background = isError ? '#ffebee' : '#e8f5e9';
      status.style.color = isError ? '#c62828' : '#2e7d32';
    };

    // Subscribe to connection state changes for auto-join
    let unsubscribeConnectionState = null;

    // Connect WebSocket
    document.getElementById('connectWS').addEventListener('click', async () => {
      const userName = document.getElementById('userName').value;
      const roomId = document.getElementById('roomId').value;

      if (!userName) {
        setStatus('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', true);
        return;
      }

      if (!roomId) {
        setStatus('ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', true);
        return;
      }

      setStatus('Guest í† í° ìƒì„± ì¤‘...');

      try {
        // Create guest user with valid token
        const response = await fetch('http://localhost:3000/api/auth/guest', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            displayName: userName,
          }),
        });

        if (!response.ok) {
          throw new Error('Failed to create guest user');
        }

        const { accessToken, user } = await response.json();

        // Store token and user info
        localStorage.setItem('animal-zoom:token', accessToken);
        localStorage.setItem('animal-zoom:user', JSON.stringify(user));

        useChatStore.getState().setUser(user.id, user.displayName);
        useChatStore.getState().connectWebSocket();
        useChatStore.getState().setIsOpen(true);

        setStatus('WebSocket ì—°ê²° ì‹œë„ ì¤‘...');
      } catch (error) {
        console.error('Guest token creation failed:', error);
        setStatus('âŒ Guest í† í° ìƒì„± ì‹¤íŒ¨: ' + error.message, true);
        return;
      }

      // Subscribe to connection state for auto-join
      if (unsubscribeConnectionState) {
        unsubscribeConnectionState();
      }

      unsubscribeConnectionState = useChatStore.subscribe(
        (state) => state.connectionState,
        (connectionState) => {
          if (connectionState === 'connected') {
            // Auto-join room when connected
            setTimeout(() => {
              const store = useChatStore.getState();
              const currentRoomId = document.getElementById('roomId').value;

              if (currentRoomId) {
                store.joinRoom(currentRoomId);
                setStatus(`âœ… WebSocket ì—°ê²° ì™„ë£Œ - ${currentRoomId} ë°©ì— ìë™ ì°¸ê°€`);
              }
            }, 100);
          } else if (connectionState === 'error') {
            setStatus('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨', true);
          } else if (connectionState === 'disconnected') {
            setStatus('ì—°ê²° ëŠê¹€', true);
          }
        }
      );
    });

    // Join room (manual - for reference or re-join)
    document.getElementById('joinRoom').addEventListener('click', () => {
      const roomId = document.getElementById('roomId').value;
      const store = useChatStore.getState();

      if (!roomId) {
        setStatus('ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', true);
        return;
      }

      if (store.connectionState !== 'connected') {
        setStatus('ë¨¼ì € WebSocketì— ì—°ê²°í•˜ì„¸ìš”', true);
        return;
      }

      store.joinRoom(roomId);
      setStatus(`âœ… ${roomId} ë°©ì— ìˆ˜ë™ ì°¸ê°€ ìš”ì²­`);
    });

    // Add test message
    document.getElementById('addTestMessage').addEventListener('click', () => {
      const store = useChatStore.getState();

      if (!store.roomId || !store.userId) {
        setStatus('ë¨¼ì € ì±„íŒ…ì„ ì´ˆê¸°í™”í•˜ì„¸ìš”', true);
        return;
      }

      const testMessages = [
        'ì•ˆë…•í•˜ì„¸ìš”!',
        'í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤',
        'ì±„íŒ…ì´ ì˜ ì‘ë™í•˜ë‚˜ìš”?',
        'ë©‹ì§„ UIë„¤ìš”! ğŸ˜Š',
        'ì—¬ëŸ¬ ì¤„ë¡œ\në©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ë„ ìˆë‚˜ìš”?'
      ];

      const message = testMessages[Math.floor(Math.random() * testMessages.length)];

      store.addMessage({
        id: `${Date.now()}-${Math.random()}`,
        roomId: store.roomId,
        userId: `other-user-${Math.random()}`,
        userName: 'ë‹¤ë¥¸ ì‚¬ìš©ì',
        message,
        timestamp: new Date(),
        type: 'text'
      });

      setStatus('í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì¶”ê°€ë¨');
    });

    // Clear messages
    document.getElementById('clearMessages').addEventListener('click', () => {
      useChatStore.getState().clearMessages();
      setStatus('ë©”ì‹œì§€ ì§€ì›Œì§');
    });

    // Toggle chat
    document.getElementById('toggleChat').addEventListener('click', () => {
      useChatStore.getState().toggleChat();
      const isOpen = useChatStore.getState().isOpen;
      setStatus(isOpen ? 'ì±„íŒ… ì—´ë¦¼' : 'ì±„íŒ… ë‹«í˜');
    });

    // Auto-initialize on load (UI only - no WebSocket)
    setTimeout(() => {
      useChatStore.getState().setIsOpen(true);
      setStatus('âœ… ì±„íŒ… UI ë¡œë“œ ì™„ë£Œ - "WebSocket ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”');
    }, 500);

    console.log('âœ… Chat UI Demo initialized');
  </script>
</body>
</html>
