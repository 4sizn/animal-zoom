# Main Docker Compose configuration for Animal Zoom
# This file orchestrates the API server and includes infrastructure services

include:
  - docker/docker-compose.services.yml

services:
  api:
    build:
      context: ./apiServer
      dockerfile: Dockerfile
    container_name: animal-zoom-api
    env_file:
      - .env.docker
    ports:
      - "3000:3000"  # HTTP API
      - "3001:3001"  # WebSocket
    volumes:
      # Mount source code for hot reload (development only)
      - ./apiServer/src:/app/src:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - animal-zoom-network
    restart: unless-stopped
    # Run migrations before starting the application
    command: sh -c "bun src/database/migrate.ts && bun run dist/main.js"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
